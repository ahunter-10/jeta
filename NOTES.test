######## Regression test for primary (HEAD) update_archive.py and fetch.py

# First make test data.  This sets ENG_ARCHIVE in that window.

source make_test_eng_archive.csh

# Basic sanity test with some plots

setenv ENG_ARCHIVE $PWD/test/eng_archive
test/make_plots.py

# Regression test.  Get_regr_vals.py uses the local ../Ska/engarchive/fetch.py
# if --test is given, otherwise uses the installed Ska version.  It sets
# ENG_ARCHIVE internally prior to importing fetch.

unsetenv ENG_ARCHIVE
cd test
  ./get_regr_vals.py --start 2010:265 --stop 2010:285
  ./get_regr_vals.py --start 2010:265 --stop 2010:285 --test 
  ./compare_regr_vals.py
cd ..

## 2011-Feb-18: All tests pass for rev 56:5b12e819e1df

######## OCC functionality testing

source make_test_eng_archive.csh
mv test/eng_archive test/eng_archive.head

rm -rf test/eng_archive_occ
rm -rf test/eng_archive 
tar -x -C test -f test/eng_archive.tar.gz 
cp -rp test/eng_archive test/eng_archive_occ

rm -f test/make_eng_archive.log
rm -f test/make_eng_archive_occ.log
touch test/make_eng_archive.log
touch test/make_eng_archive_occ.log

foreach doy (271 272 273 274 275 276 277 278 279 280 )
  setenv ENG_ARCHIVE $PWD/test/eng_archive
  ./update_archive.py --date-now "2010:$doy" --data-root $ENG_ARCHIVE >>& test/make_eng_archive.log
  ./transfer_stage.py --data-root $ENG_ARCHIVE >>& test/make_eng_archive.log

  setenv ENG_ARCHIVE $PWD/test/eng_archive_occ
  ./transfer_stage.py --data-root $ENG_ARCHIVE --occ >>& test/make_eng_archive_occ.log
  ./update_archive.py --date-now "2010:$doy" --data-root $ENG_ARCHIVE --occ >>& test/make_eng_archive_occ.log
end

# Regression tests:
# diff logs (after cutting time columns and replacing _occ with ""): No diffs seen
# diff "ls -l" from respective MSID and 5min directories.  Only diffs in times seen.
# diff binary MSID files.  Some diffs seens...

cd test
  unsetenv ENG_ARCHIVE
  ./get_regr_vals.py --start 2010:265 --stop 2010:279
  setenv ENG_ARCHIVE $PWD/eng_archive_occ
  ./get_regr_vals.py --test --start 2010:265 --stop 2010:279
  ./compare_regr_vals.py
cd ..

## 2011-Feb-18: All tests pass for rev 56:5b12e819e1df
## 2011-Feb-20: All tests pass for rev 60
